<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TeamPDF</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
:root {
  --bg:#0b0c10;
  --panel:#15161c;
  --panel-soft:#1c1e26;
  --accent:#b00b55;
  --accent-hover:#c81464;
  --border:#2a2d38;
  --text:#f4f5f7;
  --muted:#a0a3b1;
  --radius-sm:8px;
  --radius-md:12px;
  --radius-lg:18px;
  --shadow-lg:0 20px 40px rgba(0,0,0,.45);
  --shadow-sm:0 8px 18px rgba(0,0,0,.35);
}

* { box-sizing:border-box; font-family:Inter,system-ui,sans-serif; }

body {
  margin:0;
  height:100vh;
  background:radial-gradient(1200px 600px at 50% -20%,#171823,var(--bg));
  color:var(--text);
  overflow:hidden;
}

/* ---------- Layout ---------- */
#workspace { display:none; height:100vh; }

header {
  height:64px;
  background:linear-gradient(180deg,#161820,var(--panel));
  padding:0 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid var(--border);
}

header strong {
  color:var(--accent);
  letter-spacing:.04em;
}

#viewer {
  height:calc(100vh - 64px);
  overflow-y:auto;
  padding:32px 0 64px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:36px;
}

/* ---------- PDF ---------- */
.page {
  position:relative;
  border-radius:var(--radius-md);
  overflow:hidden;
  box-shadow:var(--shadow-lg);
  background:#000;
}

.pdf-layer,
.draw-layer {
  display:block;
}

.draw-layer {
  position:absolute;
  inset:0;
  z-index:2;
  cursor:crosshair;
}

/* ---------- Home ---------- */
.center {
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
}

.card {
  width:380px;
  padding:42px 40px 46px;
  background:linear-gradient(180deg,var(--panel-soft),var(--panel));
  border-radius:var(--radius-lg);
  border:1px solid var(--border);
  box-shadow:var(--shadow-lg);
  text-align:center;
}

.card h1 {
  margin:0 0 28px;
  font-size:28px;
  letter-spacing:.04em;
}

.card input {
  width:100%;
  padding:12px 14px;
  margin-bottom:14px;
  background:#0f1016;
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text);
}

.card input::placeholder {
  color:var(--muted);
  letter-spacing:.08em;
}

/* ---------- Buttons ---------- */
button {
  appearance:none;
  border:none;
  cursor:pointer;
  padding:12px 18px;
  border-radius:var(--radius-sm);
  font-weight:600;
  font-size:14px;
  letter-spacing:.04em;
  transition:background .15s,transform .15s,box-shadow .15s;
}

button:active { transform:translateY(1px); }

button:not(.secondary) {
  background:linear-gradient(135deg,var(--accent),var(--accent-hover));
  color:#fff;
  box-shadow:0 10px 20px rgba(176,11,85,.35);
}

button:not(.secondary):hover {
  background:linear-gradient(135deg,var(--accent-hover),var(--accent));
}

button.secondary {
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
}

button.secondary:hover {
  border-color:var(--accent);
  color:var(--accent);
}

/* ---------- Toolbar ---------- */
#toolbar {
  position:fixed;
  bottom:24px;
  right:24px;
  padding:14px;
  background:linear-gradient(180deg,var(--panel-soft),var(--panel));
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  display:flex;
  flex-direction:column;
  gap:14px;
  box-shadow:var(--shadow-sm);
  z-index:999;
}

.tool-row {
  display:flex;
  gap:10px;
  align-items:center;
}

.tool {
  width:34px;
  height:34px;
  border-radius:50%;
  border:2px solid var(--border);
  cursor:pointer;
}

.tool:hover { border-color:var(--accent); }

.tool.active {
  outline:2px solid var(--accent);
  outline-offset:2px;
}

.tool.eraser {
  border-radius:var(--radius-sm);
  background:#0f1016;
  color:#fff;
  font-weight:700;
  font-size:12px;
}

input[type=color] {
  width:34px;
  height:34px;
  padding:0;
  border:none;
  background:none;
}

input[type=range] { width:160px; }

#settingsBtn {
  margin-top:6px;
  padding:8px 12px;
  border-radius:10px;
  font-size:13px;
}
</style>
</head>

<body>

<div class="center" id="home">
  <div class="card">
    <h1>Team<span style="color:#b00b55">PDF</span></h1>
    <button onclick="hostRoom()">Host Session</button><br><br>
    <input id="joinInput" placeholder="ROOM CODE" />
    <button class="secondary" onclick="joinRoom()">Join Session</button>
  </div>
</div>

<div id="workspace">
  <header>
    <div>Room <strong id="roomLabel"></strong></div>
    <div id="uploadControls">
      <label class="secondary" style="padding:8px 14px;border-radius:8px;cursor:pointer">
        Upload PDF
        <input type="file" id="pdfUpload" hidden />
      </label>
      <button onclick="downloadAnnotatedPDF()">â¬‡ Export</button>
    </div>
  </header>
  <div id="viewer"></div>
</div>

<div id="toolbar">
  <div class="tool-row">
    <div class="tool color" data-index="0"></div>
    <div class="tool color" data-index="1"></div>
    <div class="tool color" data-index="2"></div>
    <div class="tool eraser">[ ]</div>
    <input type="color" id="colorPicker" />
  </div>
  <input type="range" id="sizeSlider" min="1" max="20" value="3" />
  <button class="secondary" id="settingsBtn">âš™ Settings</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const firebaseConfig = {
  apiKey:"AIzaSyDAScHIxTwrXQEVCnEYxizNPSRKiuYsqqA",
  authDomain:"teampdf-7ec12.firebaseapp.com",
  databaseURL:"https://teampdf-7ec12-default-rtdb.firebaseio.com",
  projectId:"teampdf-7ec12",
  storageBucket:"teampdf-7ec12.firebasestorage.app",
  messagingSenderId:"307072046237",
  appId:"1:307072046237:web:d1f44f115fdf199b5a7074"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let roomCode, isHost=false, pdfUrl;
let tool="pen", activeProfile=0, brushSize=3;
const profiles=["#b00b55","#00c2ff","#00ff9c"];

const colorTools=document.querySelectorAll(".tool.color");

colorTools.forEach(t=>{
  const i=+t.dataset.index;
  t.style.background=profiles[i];
  t.onclick=()=>{ tool="pen"; activeProfile=i; updateToolbar(); };
});

document.querySelector(".eraser").onclick=()=>{ tool="eraser"; updateToolbar(); };
settingsBtn.onclick=()=>alert("Settings coming soon ðŸ‘€");

colorPicker.oninput=e=>{
  profiles[activeProfile]=e.target.value;
  colorTools[activeProfile].style.background=e.target.value;
};

sizeSlider.oninput=e=>brushSize=+e.target.value;

function updateToolbar(){
  document.querySelectorAll(".tool").forEach(t=>t.classList.remove("active"));
  if(tool==="pen") colorTools[activeProfile].classList.add("active");
  if(tool==="eraser") document.querySelector(".eraser").classList.add("active");
}
updateToolbar();

window.hostRoom=()=>{ isHost=true; roomCode=Math.random().toString(36).slice(2,7).toUpperCase(); start(); };
window.joinRoom=()=>{ roomCode=joinInput.value.toUpperCase(); if(roomCode) start(); };

async function start(){
  home.style.display="none";
  workspace.style.display="block";
  roomLabel.textContent=roomCode;

  if(!isHost){ uploadControls.style.display="none"; toolbar.style.display="none"; }

  const pdfRef=ref(db,`rooms/${roomCode}/pdf`);
  const drawRef=ref(db,`rooms/${roomCode}/draw`);

  if(isHost){
    pdfUpload.onchange=async e=>{
      const f=e.target.files[0];
      const r=sRef(storage,`pdfs/${roomCode}.pdf`);
      await uploadBytes(r,f);
      pdfUrl=await getDownloadURL(r);
      await set(pdfRef,pdfUrl);
      renderPDF(pdfUrl);
    };
  }

  const snap=await get(pdfRef);
  if(snap.exists()){ pdfUrl=snap.val(); renderPDF(pdfUrl); }

  onChildAdded(drawRef,s=>drawStroke(s.val()));
}

function drawStroke(s){
  const c=document.getElementById(`draw-${s.page}`);
  if(!c) return;
  const ctx=c.getContext("2d");
  ctx.save();
  ctx.lineCap="round";
  ctx.lineWidth=s.size;
  ctx.globalCompositeOperation=s.erase?"destination-out":"source-over";
  ctx.strokeStyle=s.color;
  ctx.beginPath();
  ctx.moveTo(s.x1,s.y1);
  ctx.lineTo(s.x2,s.y2);
  ctx.stroke();
  ctx.restore();
}

async function renderPDF(url){
  viewer.innerHTML="";
  const pdf=await pdfjsLib.getDocument(url).promise;

  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const v=p.getViewport({scale:1.4});

    const w=document.createElement("div");
    w.className="page";
    w.style.width=`${v.width}px`;
    w.style.height=`${v.height}px`;

    const pc=document.createElement("canvas");
    const dc=document.createElement("canvas");

    pc.className="pdf-layer";
    dc.className="draw-layer";

    pc.width=dc.width=v.width;
    pc.height=dc.height=v.height;
    dc.id=`draw-${i}`;

    w.append(pc,dc);
    viewer.appendChild(w);

    await p.render({canvasContext:pc.getContext("2d"),viewport:v}).promise;
    enableDrawing(dc,i);
  }
}

function enableDrawing(c,page){
  let d=false,lx,ly;
  const r=ref(db,`rooms/${roomCode}/draw`);

  c.onmousedown=e=>{
    d=true;
    const b=c.getBoundingClientRect();
    lx=e.clientX-b.left;
    ly=e.clientY-b.top;
  };

  c.onmouseup=c.onmouseleave=()=>d=false;

  c.onmousemove=e=>{
    if(!d) return;
    const b=c.getBoundingClientRect();
    const x=e.clientX-b.left;
    const y=e.clientY-b.top;

    push(r,{page,x1:lx,y1:ly,x2:x,y2:y,color:profiles[activeProfile],erase:tool==="eraser",size:brushSize});
    lx=x; ly=y;
  };
}

window.downloadAnnotatedPDF=async()=>{
  if(!pdfUrl) return;
  const bytes=await fetch(pdfUrl).then(r=>r.arrayBuffer());
  const doc=await PDFLib.PDFDocument.load(bytes);

  for(let i=0;i<doc.getPageCount();i++){
    const p=doc.getPages()[i];
    const c=document.getElementById(`draw-${i+1}`);
    if(!c) continue;

    const png=await fetch(c.toDataURL()).then(r=>r.arrayBuffer());
    const img=await doc.embedPng(png);

    const sx=p.getWidth()/c.width;
    const sy=p.getHeight()/c.height;

    p.drawImage(img,{
      x:0,y:0,
      width:c.width*sx,
      height:c.height*sy
    });
  }

  const out=await doc.save();
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([out],{type:"application/pdf"}));
  a.download=`TeamPDF-${roomCode}.pdf`;
  a.click();
};
</script>
</body>
</html>
