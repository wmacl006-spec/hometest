<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PDFlive</title>

<link rel="icon" href="logo.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
:root {
  --bg:#0e0e11;
  --panel:#16161c;
  --accent:#b00b55;
  --accent-hover:#d4146a;
  --border:#262633;
  --text:#f2f2f2;
  --shadow:0 10px 30px rgba(0,0,0,0.5);
}

* { box-sizing:border-box; font-family:Inter,sans-serif; }

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}

/* ---------- HOME ---------- */
.center {
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card {
  background:var(--panel);
  padding:40px;
  border-radius:20px;
  width:360px;
  text-align:center;
  box-shadow:var(--shadow);
}

button {
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,#b00b55,#d4146a);
  color:white;
  font-weight:600;
  cursor:pointer;
  margin-top:10px;
}

button.secondary {
  background:transparent;
  border:2px solid var(--accent);
  color:var(--accent);
}

input {
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#111;
  color:white;
  text-align:center;
}

/* ---------- WORKSPACE ---------- */
#workspace { display:none; height:100vh; }

header {
  height:64px;
  background:var(--panel);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 20px;
  border-bottom:1px solid var(--border);
}

header button {
  padding:8px 12px;
  border-radius:10px;
  background:var(--accent);
  color:white;
  border:none;
  cursor:pointer;
}

header .right {
  display:flex;
  gap:10px;
  align-items:center;
}

#viewer {
  height:calc(100vh - 64px);
  overflow:auto;
  padding:30px 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:30px;
}

/* ---------- PDF ---------- */
.page {
  position:relative;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

.pdf-layer { z-index:1; }
.draw-layer {
  position:absolute;
  inset:0;
  z-index:2;
}
</style>
</head>

<body>

<!-- HOME -->
<div id="home" class="center">
  <div class="card">
    <h1>PDF<span style="color:#b00b55">live</span></h1>
    <button onclick="hostRoom()">Host</button>
    <input id="joinInput" placeholder="ROOM CODE" />
    <button class="secondary" onclick="joinRoom()">Join</button>
  </div>
</div>

<!-- WORKSPACE -->
<div id="workspace">
  <header>
    <div>Room <strong id="roomLabel"></strong></div>
    <div class="right">
      <label>
        <button>Upload</button>
        <input id="pdfUpload" type="file" hidden>
      </label>

      <button onclick="zoomOut()">−</button>
      <button onclick="zoomIn()">+</button>

      <button onclick="downloadAnnotatedPDF()">⬇ PDF</button>
      <button onclick="leaveRoom()">Leave</button>
    </div>
  </header>

  <div id="viewer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ---------- FIREBASE ---------- */
const app = initializeApp({
  apiKey:"AIzaSyDAScHIxTwrXQEVCnEYxizNPSRKiuYsqqA",
  authDomain:"teampdf-7ec12.firebaseapp.com",
  databaseURL:"https://teampdf-7ec12-default-rtdb.firebaseio.com",
  projectId:"teampdf-7ec12",
  storageBucket:"teampdf-7ec12.firebasestorage.app",
  messagingSenderId:"307072046237",
  appId:"1:307072046237:web:d1f44f115fdf199b5a7074"
});

const db = getDatabase(app);
const storage = getStorage(app);

/* ---------- STATE ---------- */
let roomCode, isHost=false, pdfUrl;
let scale = 1.4;

/* ---------- ROOM ---------- */
window.hostRoom = () => {
  isHost = true;
  roomCode = Math.random().toString(36).slice(2,7).toUpperCase();
  start();
};

window.joinRoom = () => {
  roomCode = joinInput.value.toUpperCase();
  if (roomCode) start();
};

async function start(){
  home.style.display="none";
  workspace.style.display="block";
  roomLabel.textContent = roomCode;

  const pdfRef = ref(db,`rooms/${roomCode}/pdf`);
  const drawRef = ref(db,`rooms/${roomCode}/draw`);

  if(isHost){
    pdfUpload.onchange = async e => {
      const f = e.target.files[0];
      const r = sRef(storage,`pdfs/${roomCode}.pdf`);
      await uploadBytes(r,f);
      pdfUrl = await getDownloadURL(r);
      await set(pdfRef,pdfUrl);
      await renderPDF();
    };
  }

  const snap = await get(pdfRef);
  if(snap.exists()){
    pdfUrl = snap.val();
    await renderPDF();
  }

  onChildAdded(drawRef, s => drawStroke(s.val()));
}

/* ---------- PDF RENDER ---------- */
async function renderPDF(){
  viewer.innerHTML="";
  const pdf = await pdfjsLib.getDocument(pdfUrl).promise;

  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale });

    const wrap = document.createElement("div");
    wrap.className="page";

    const pc = document.createElement("canvas");
    const dc = document.createElement("canvas");
    pc.width = dc.width = viewport.width;
    pc.height = dc.height = viewport.height;
    dc.id = `draw-${i}`;

    wrap.append(pc,dc);
    viewer.appendChild(wrap);

    await page.render({
      canvasContext: pc.getContext("2d"),
      viewport
    }).promise;

    if(isHost) enableDrawing(dc,i);
  }
}

/* ---------- DRAWING ---------- */
function enableDrawing(c,page){
  let drawing=false, lx, ly;
  const r = ref(db,`rooms/${roomCode}/draw`);

  c.onmousedown=e=>{
    drawing=true;
    const b=c.getBoundingClientRect();
    lx=e.clientX-b.left;
    ly=e.clientY-b.top;
  };

  c.onmousemove=e=>{
    if(!drawing) return;
    const b=c.getBoundingClientRect();
    const x=e.clientX-b.left;
    const y=e.clientY-b.top;

    push(r,{page,x1:lx,y1:ly,x2:x,y2:y,color:"#b00b55",size:3});
    lx=x; ly=y;
  };

  c.onmouseup = c.onmouseleave = ()=>drawing=false;
}

function drawStroke(s){
  const c=document.getElementById(`draw-${s.page}`);
  if(!c) return;
  const ctx=c.getContext("2d");
  ctx.lineCap="round";
  ctx.lineWidth=s.size;
  ctx.strokeStyle=s.color;
  ctx.beginPath();
  ctx.moveTo(s.x1,s.y1);
  ctx.lineTo(s.x2,s.y2);
  ctx.stroke();
}

/* ---------- ZOOM ---------- */
window.zoomIn = () => {
  scale = Math.min(scale + 0.2, 3);
  renderPDF();
};

window.zoomOut = () => {
  scale = Math.max(scale - 0.2, 0.5);
  renderPDF();
};

/* ---------- EXPORT ---------- */
window.downloadAnnotatedPDF = async () => {
  const bytes = await fetch(pdfUrl).then(r=>r.arrayBuffer());
  const doc = await PDFLib.PDFDocument.load(bytes);
  const pages = doc.getPages();

  for(let i=0;i<pages.length;i++){
    const canvas = document.getElementById(`draw-${i+1}`);
    if(!canvas) continue;
    const png = await doc.embedPng(canvas.toDataURL());
    const {width,height} = pages[i].getSize();
    pages[i].drawImage(png,{x:0,y:0,width,height});
  }

  const blob = new Blob([await doc.save()],{type:"application/pdf"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`PDFlive-${roomCode}.pdf`;
  a.click();
};

/* ---------- LEAVE ---------- */
window.leaveRoom = () => location.reload();
</script>

</body>
</html>
