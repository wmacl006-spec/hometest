<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live PDF Editor (Firebase)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    canvas { border: 1px solid #333; cursor: crosshair; }
    #controls { margin-bottom: 10px; }
  </style>
</head>
<body>

<h2>Live PDF Whiteboard</h2>

<div id="controls">
  <input type="file" id="pdfInput" accept="application/pdf" />
  <button onclick="createSession()">Create Session</button>
  <input type="text" id="sessionCode" placeholder="Enter session code" />
  <button onclick="joinSession()">Join Session</button>
</div>

<canvas id="pdfCanvas"></canvas>

<script>
// ---------------- FIREBASE CONFIG ----------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
};

firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const db = firebase.firestore();

// ---------------- GLOBALS ----------------
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');
let pdfDoc = null;
let page = null;
let drawing = false;
let sessionId = null;

// ---------------- PDF UPLOAD + RENDER ----------------
document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const ref = storage.ref(`pdfs/${Date.now()}_${file.name}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();

  await loadPDF(url);
  if (sessionId) {
    await db.collection('sessions').doc(sessionId).set({ pdfUrl: url }, { merge: true });
  }
});

async function loadPDF(url) {
  pdfDoc = await pdfjsLib.getDocument(url).promise;
  page = await pdfDoc.getPage(1);
  const viewport = page.getViewport({ scale: 1.5 });
  canvas.width = viewport.width;
  canvas.height = viewport.height;

  await page.render({ canvasContext: ctx, viewport }).promise;
}

// ---------------- DRAWING ----------------
canvas.addEventListener('mousedown', (e) => {
  drawing = true;
  draw(e.offsetX, e.offsetY, false);
});

canvas.addEventListener('mousemove', (e) => {
  if (!drawing) return;
  draw(e.offsetX, e.offsetY, true);
});

canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mouseleave', () => drawing = false);

function draw(x, y, dragging) {
  ctx.fillStyle = 'red';
  ctx.beginPath();
  ctx.arc(x, y, 2, 0, Math.PI * 2);
  ctx.fill();

  if (sessionId) {
    db.collection('sessions').doc(sessionId)
      .collection('strokes')
      .add({ x, y, t: Date.now() });
  }
}

// ---------------- LIVE SYNC ----------------
async function createSession() {
  const doc = await db.collection('sessions').add({ created: Date.now() });
  sessionId = doc.id;
  alert('Session code: ' + sessionId);
  listenForStrokes();
}

async function joinSession() {
  sessionId = document.getElementById('sessionCode').value.trim();
  if (!sessionId) return;

  const snap = await db.collection('sessions').doc(sessionId).get();
  if (!snap.exists) return alert('Invalid session');

  if (snap.data().pdfUrl) {
    await loadPDF(snap.data().pdfUrl);
  }

  listenForStrokes();
}

function listenForStrokes() {
  db.collection('sessions').doc(sessionId)
    .collection('strokes')
    .orderBy('t')
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const { x, y } = change.doc.data();
          ctx.fillStyle = 'red';
          ctx.beginPath();
          ctx.arc(x, y, 2, 0, Math.PI * 2);
          ctx.fill();
        }
      });
    });
}
</script>

</body>
</html>
