<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TeamPDF</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
:root {
  --bg:#0e0e11;
  --panel:#16161c;
  --accent:#b00b55;
  --text:#f2f2f2;
  --muted:#9a9aa3;
  --border:#262633;
}

* { box-sizing:border-box; font-family:'Inter',sans-serif; }

body {
  margin:0;
  background:radial-gradient(circle at top,#1a1a22,var(--bg));
  color:var(--text);
  height:100vh;
  overflow:hidden;
}

button {
  background:linear-gradient(135deg,var(--accent),#d4146a);
  border:none;
  color:white;
  padding:12px 16px;
  border-radius:14px;
  font-weight:600;
  cursor:pointer;
}

button.secondary {
  background:transparent;
  border:1px solid var(--border);
}

.icon-btn {
  background:var(--panel);
  border:1px solid var(--border);
}

input[type=file] { display:none; }

.center {
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
}

.card {
  background:var(--panel);
  padding:42px;
  border-radius:22px;
  width:380px;
  text-align:center;
}

.stack {
  display:flex;
  flex-direction:column;
  gap:16px;
  margin-top:24px;
}

#workspace { display:none; height:100vh; }

header {
  background:var(--panel);
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid var(--border);
}

header .right {
  display:flex;
  gap:12px;
  align-items:center;
}

#viewer {
  height:calc(100vh - 64px);
  overflow-y:auto;
  padding:28px 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:36px;
}

/* ---- CRITICAL FIX ---- */
.page {
  position:relative;
}

canvas {
  display:block;
}

/* ---- TOOLBAR ---- */
#toolbar {
  position:fixed;
  bottom:24px;
  right:24px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  display:none;
  flex-direction:column;
  gap:12px;
  z-index:1000;
}

.tool-row {
  display:flex;
  gap:10px;
  justify-content:center;
}

.color-btn {
  width:26px;
  height:26px;
  border-radius:50%;
  border:2px solid transparent;
  cursor:pointer;
}

.color-btn.active {
  border-color:white;
}

.tool-btn {
  background:#0b0b10;
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 10px;
  color:var(--text);
  cursor:pointer;
}

input[type=range] { width:120px; }
</style>
</head>

<body>

<div class="center" id="home">
  <div class="card">
    <h1>Team<span style="color:#b00b55">PDF</span></h1>
    <p class="muted">Live collaborative PDF annotation</p>

    <div class="stack">
      <button onclick="hostRoom()">Host a Session</button>
      <input id="joinInput" placeholder="ROOM CODE" />
      <button class="secondary" onclick="joinRoom()">Join Session</button>
    </div>
  </div>
</div>

<div id="workspace">
<header>
  <div>
    <strong>Room</strong> <span id="roomLabel" style="color:#b00b55"></span>
  </div>
  <div class="right">
    <div id="hostControls">
      <label for="pdfUpload" class="tool-btn">Upload PDF</label>
      <input type="file" id="pdfUpload" accept="application/pdf">
      <button class="icon-btn" onclick="downloadAnnotatedPDF()">â¬‡ PDF</button>
    </div>
    <button class="secondary" onclick="location.reload()">Leave</button>
  </div>
</header>

<div id="viewer"></div>
</div>

<!-- TOOLBAR -->
<div id="toolbar">
  <div class="tool-row">
    <div class="color-btn active" id="c0"></div>
    <div class="color-btn" id="c1"></div>
    <div class="color-btn" id="c2"></div>
  </div>
  <div class="tool-row">
    <button class="tool-btn" id="editColor">ðŸŽ¨</button>
    <button class="tool-btn" id="eraser">Eraser</button>
  </div>
  <div class="tool-row">
    <input type="range" id="sizeSlider" min="1" max="12" value="3">
  </div>
  <input type="color" id="colorPicker" style="display:none">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const app = initializeApp({
  apiKey:"AIzaSyDAScHIxTwrXQEVCnEYxizNPSRKiuYsqqA",
  authDomain:"teampdf-7ec12.firebaseapp.com",
  databaseURL:"https://teampdf-7ec12-default-rtdb.firebaseio.com",
  projectId:"teampdf-7ec12",
  storageBucket:"teampdf-7ec12.firebasestorage.app",
  messagingSenderId:"307072046237",
  appId:"1:307072046237:web:d1f44f115fdf199b5a7074"
});

const db = getDatabase(app);
const storage = getStorage(app);

let roomCode, isHost=false, pdfUrl=null;
let profiles=['#b00b55','#00c2ff','#7cff00'];
let activeProfile=0, brushSize=3, isEraser=false;

window.hostRoom=()=>{isHost=true;roomCode=Math.random().toString(36).substr(2,5).toUpperCase();start();}
window.joinRoom=()=>{roomCode=document.getElementById('joinInput').value.toUpperCase();if(roomCode)start();}

async function start(){
  home.style.display='none';
  workspace.style.display='block';
  roomLabel.textContent=roomCode;

  if(isHost){
    toolbar.style.display='flex';
  } else {
    hostControls.style.display='none';
  }

  const pdfRef=ref(db,`rooms/${roomCode}/pdf`);
  const drawRef=ref(db,`rooms/${roomCode}/draw`);

  if(isHost){
    pdfUpload.onchange=async e=>{
      const f=e.target.files[0];
      if(!f) return;
      const r=sRef(storage,`pdfs/${roomCode}.pdf`);
      await uploadBytes(r,f);
      pdfUrl=await getDownloadURL(r);
      await set(pdfRef,pdfUrl);
      renderPDF(pdfUrl);
    };
  }

  const snap=await get(pdfRef);
  if(snap.exists()){pdfUrl=snap.val();renderPDF(pdfUrl);}

  onChildAdded(drawRef,s=>drawStroke(s.val()));
}

function drawStroke({page,x1,y1,x2,y2,color,size,erase}){
  const c=document.getElementById(`draw-${page}`);
  if(!c) return;
  const ctx=c.getContext('2d');
  ctx.globalCompositeOperation=erase?'destination-out':'source-over';
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.globalCompositeOperation='source-over';
}

async function renderPDF(url){
  viewer.innerHTML='';
  const pdf=await pdfjsLib.getDocument(url).promise;

  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:1.4});

    const wrap=document.createElement('div');
    wrap.className='page';

    const pdfC=document.createElement('canvas');
    const drawC=document.createElement('canvas');

    pdfC.width=drawC.width=vp.width;
    pdfC.height=drawC.height=vp.height;

    drawC.id=`draw-${i}`;
    drawC.style.position='absolute';
    drawC.style.top='0';
    drawC.style.left='0';

    wrap.append(pdfC,drawC);
    viewer.appendChild(wrap);

    await page.render({canvasContext:pdfC.getContext('2d'),viewport:vp}).promise;
    if(isHost) enableDraw(drawC,i);
  }
}

function enableDraw(c,page){
  let d=false,lx,ly;
  const r=ref(db,`rooms/${roomCode}/draw`);

  c.onmousedown=e=>{
    d=true;
    const b=c.getBoundingClientRect();
    lx=e.clientX-b.left; ly=e.clientY-b.top;
  };

  c.onmouseup=c.onmouseleave=()=>d=false;

  c.onmousemove=e=>{
    if(!d) return;
    const b=c.getBoundingClientRect();
    const x=e.clientX-b.left, y=e.clientY-b.top;
    push(r,{page,x1:lx,y1:ly,x2:x,y2:y,color:profiles[activeProfile],size:brushSize,erase:isEraser});
    lx=x; ly=y;
  };
}

/* Toolbar */
['c0','c1','c2'].forEach((id,i)=>{
  const b=document.getElementById(id);
  b.style.background=profiles[i];
  b.onclick=()=>{
    document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    activeProfile=i; isEraser=false;
  };
});

editColor.onclick=()=>{colorPicker.value=profiles[activeProfile];colorPicker.click();}
colorPicker.oninput=e=>{
  profiles[activeProfile]=e.target.value;
  document.getElementById(`c${activeProfile}`).style.background=e.target.value;
};
eraser.onclick=()=>isEraser=true;
sizeSlider.oninput=e=>brushSize=+e.target.value;

window.downloadAnnotatedPDF=async()=>{
  if(!isHost||!pdfUrl) return;
  const bytes=await fetch(pdfUrl).then(r=>r.arrayBuffer());
  const doc=await PDFLib.PDFDocument.load(bytes);
  const pages=doc.getPages();
  for(let i=0;i<pages.length;i++){
    const c=document.getElementById(`draw-${i+1}`);
    if(!c) continue;
    const img=await doc.embedPng(c.toDataURL());
    const {width,height}=pages[i].getSize();
    pages[i].drawImage(img,{x:0,y:0,width,height});
  }
  const out=await doc.save();
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([out],{type:'application/pdf'}));
  a.download=`TeamPDF-${roomCode}.pdf`;
  a.click();
};
</script>
</body>
</html>
