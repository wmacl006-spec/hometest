<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TeamPDF</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
:root {
  --bg:#0e0e11;
  --panel:#16161c;
  --accent:#b00b55;
  --accent-hover:#d4146a;
  --border:#262633;
  --text:#f2f2f2;
}

* { box-sizing:border-box; font-family:Inter,sans-serif; }

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}

/* ---------- Home ---------- */
#home {
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card {
  background:var(--panel);
  padding:40px;
  border-radius:20px;
  width:360px;
  text-align:center;
}

button {
  background:var(--accent);
  border:none;
  color:white;
  padding:12px;
  border-radius:12px;
  width:100%;
  cursor:pointer;
  font-weight:600;
}

button.secondary {
  background:none;
  border:2px solid var(--accent);
  color:var(--accent);
  margin-top:12px;
}

input {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#111;
  color:white;
  margin:12px 0;
}

/* ---------- Workspace ---------- */
#workspace { display:none; height:100vh; }

header {
  height:60px;
  background:var(--panel);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  border-bottom:1px solid var(--border);
}

#viewer {
  height:calc(100vh - 60px);
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px;
  gap:30px;
}

.page {
  position:relative;
}

.pdf-layer { position:relative; z-index:1; }
.draw-layer {
  position:absolute;
  inset:0;
  z-index:2;
}

/* ---------- Toolbar ---------- */
#toolbar {
  position:fixed;
  bottom:20px;
  right:20px;
  background:var(--panel);
  padding:12px;
  border-radius:18px;
  display:none;
  flex-direction:column;
  gap:10px;
  z-index:1000;
}

.tool-row {
  display:flex;
  gap:10px;
}

.tool {
  width:36px;
  height:36px;
  border-radius:50%;
  cursor:pointer;
  border:2px solid var(--border);
}

.tool.active {
  outline:3px solid var(--accent);
}

.tool.eraser {
  border-radius:10px;
  background:#111;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
}

input[type=color] {
  width:36px;
  height:36px;
  border:none;
  border-radius:50%;
}

input[type=range] {
  width:140px;
}

/* ---------- Modal ---------- */
.hidden { display:none; }

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2000;
}

.modal-card {
  background:var(--panel);
  padding:20px;
  border-radius:14px;
  width:300px;
}

.bind {
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
}

.bind input {
  width:80px;
  text-align:center;
}
</style>
</head>

<body>

<!-- HOME -->
<div id="home">
  <div class="card">
    <h1>Team<span style="color:#b00b55">PDF</span></h1>
    <button onclick="hostRoom()">Host</button>
    <input id="joinInput" placeholder="ROOM CODE">
    <button class="secondary" onclick="joinRoom()">Join</button>
  </div>
</div>

<!-- WORKSPACE -->
<div id="workspace">
  <header>
    <div>Room <strong id="roomLabel"></strong></div>
    <div>
      <label>
        Upload
        <input type="file" id="pdfUpload" hidden>
      </label>
      <button onclick="downloadPDF()">⬇ PDF</button>
      <button onclick="leaveRoom()">Leave</button>
    </div>
  </header>
  <div id="viewer"></div>
</div>

<!-- TOOLBAR -->
<div id="toolbar">
  <div class="tool-row">
    <div class="tool color" data-i="0"></div>
    <div class="tool color" data-i="1"></div>
    <div class="tool color" data-i="2"></div>
    <div class="tool eraser">E</div>
    <input type="color" id="colorPicker">
    <div class="tool" id="settingsBtn">⚙</div>
  </div>
  <input type="range" id="sizeSlider" min="1" max="20" value="3">
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal hidden">
  <div class="modal-card">
    <h3>Keybinds</h3>
    <div class="bind"><span>Color 1</span><input readonly></div>
    <div class="bind"><span>Color 2</span><input readonly></div>
    <div class="bind"><span>Color 3</span><input readonly></div>
    <div class="bind"><span>Eraser</span><input readonly></div>
    <button class="secondary" onclick="closeSettings()">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ---------- Firebase ---------- */
const app = initializeApp({
  apiKey:"AIzaSyDAScHIxTwrXQEVCnEYxizNPSRKiuYsqqA",
  authDomain:"teampdf-7ec12.firebaseapp.com",
  databaseURL:"https://teampdf-7ec12-default-rtdb.firebaseio.com",
  projectId:"teampdf-7ec12",
  storageBucket:"teampdf-7ec12.firebasestorage.app"
});

const db = getDatabase(app);
const storage = getStorage(app);

/* ---------- State ---------- */
let roomCode = null;
let isHost = false;
let pdfUrl = null;
let tool = "pen";
let activeColor = 0;
let brushSize = 3;

const colors = ["#b00b55", "#00c2ff", "#00ff9c"];

/* ---------- Room ---------- */
window.hostRoom = () => {
  isHost = true;
  roomCode = Math.random().toString(36).slice(2,7).toUpperCase();
  start();
};

window.joinRoom = () => {
  if (!joinInput.value) return;
  roomCode = joinInput.value.toUpperCase();
  start();
};

async function start() {
  home.style.display = "none";
  workspace.style.display = "block";
  roomLabel.textContent = roomCode;

  if (isHost) toolbar.style.display = "flex";

  const pdfRef = ref(db, `rooms/${roomCode}/pdf`);
  const drawRef = ref(db, `rooms/${roomCode}/draw`);

  if (isHost) {
    pdfUpload.onchange = async e => {
      const file = e.target.files[0];
      const r = sRef(storage, `pdfs/${roomCode}.pdf`);
      await uploadBytes(r, file);
      pdfUrl = await getDownloadURL(r);
      await set(pdfRef, pdfUrl);
      renderPDF(pdfUrl);
    };
  }

  const snap = await get(pdfRef);
  if (snap.exists()) {
    pdfUrl = snap.val();
    renderPDF(pdfUrl);
  }

  onChildAdded(drawRef, s => drawStroke(s.val()));
}

/* ---------- PDF ---------- */
async function renderPDF(url) {
  viewer.innerHTML = "";
  const pdf = await pdfjsLib.getDocument(url).promise;

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 1.4 });

    const wrapper = document.createElement("div");
    wrapper.className = "page";

    const pdfCanvas = document.createElement("canvas");
    const drawCanvas = document.createElement("canvas");

    pdfCanvas.width = drawCanvas.width = viewport.width;
    pdfCanvas.height = drawCanvas.height = viewport.height;
    drawCanvas.id = `draw-${i}`;

    wrapper.append(pdfCanvas, drawCanvas);
    viewer.appendChild(wrapper);

    await page.render({
      canvasContext: pdfCanvas.getContext("2d"),
      viewport
    }).promise;

    if (isHost) enableDrawing(drawCanvas, i);
  }
}

/* ---------- Drawing ---------- */
function enableDrawing(canvas, page) {
  let drawing = false, lx, ly;
  const r = ref(db, `rooms/${roomCode}/draw`);

  canvas.onmousedown = e => {
    drawing = true;
    const b = canvas.getBoundingClientRect();
    lx = e.clientX - b.left;
    ly = e.clientY - b.top;
  };

  canvas.onmouseup = canvas.onmouseleave = () => drawing = false;

  canvas.onmousemove = e => {
    if (!drawing) return;
    const b = canvas.getBoundingClientRect();
    const x = e.clientX - b.left;
    const y = e.clientY - b.top;

    push(r, {
      page,
      x1: lx, y1: ly,
      x2: x, y2: y,
      color: colors[activeColor],
      erase: tool === "eraser",
      size: brushSize
    });

    lx = x; ly = y;
  };
}

function drawStroke(s) {
  const c = document.getElementById(`draw-${s.page}`);
  if (!c) return;
  const ctx = c.getContext("2d");

  ctx.save();
  ctx.lineCap = "round";
  ctx.lineWidth = s.size;
  ctx.globalCompositeOperation = s.erase ? "destination-out" : "source-over";
  ctx.strokeStyle = s.color;

  ctx.beginPath();
  ctx.moveTo(s.x1, s.y1);
  ctx.lineTo(s.x2, s.y2);
  ctx.stroke();
  ctx.restore();
}

/* ---------- Export ---------- */
window.downloadPDF = async () => {
  const bytes = await fetch(pdfUrl).then(r => r.arrayBuffer());
  const doc = await PDFLib.PDFDocument.load(bytes);

  for (let i = 0; i < doc.getPageCount(); i++) {
    const page = doc.getPages()[i];
    const canvas = document.getElementById(`draw-${i+1}`);
    if (!canvas) continue;

    const png = await doc.embedPng(canvas.toDataURL());
    const { width, height } = page.getSize();

    page.drawImage(png, { x:0, y:0, width, height });
  }

  const blob = new Blob([await doc.save()], { type:"application/pdf" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `TeamPDF-${roomCode}.pdf`;
  a.click();
};

/* ---------- Settings ---------- */
const modal = document.getElementById("settingsModal");
document.getElementById("settingsBtn").onclick = () => modal.classList.remove("hidden");
window.closeSettings = () => modal.classList.add("hidden");

/* ---------- Leave ---------- */
window.leaveRoom = () => location.reload();
</script>

</body>
</html>
